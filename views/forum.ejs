<%- include("partials/header-logged.ejs") %>

<div class="category-filter">
  <select onchange="filterByCategory(this.value)">
    <option value="">√ñsszes kateg√≥ria</option>
    <% categories.forEach(category => { %>
      <option value="<%= category.id %>" <%= selectedCategory == category.id ? 'selected' : '' %>>
        <%= category.name %>
      </option>
    <% }); %>
  </select>
</div>

<!-- T√©ma l√©trehoz√°s gomb - csak jogosult felhaszn√°l√≥knak -->
<% if (canCreateMainThreads) { %>
  <button class="create-thread-btn" onclick="openCreateModal()">
    √öj f≈ët√©ma l√©trehoz√°sa
  </button>
<% } %>

<!-- T√©m√°k list√°ja -->
<div class="thread-list mb-3">
  <% if (threads && threads.length > 0) { %>
    <% threads.forEach(thread => { %>
      <div class="thread-item">
        <div class="thread-info">
          <a href="/thread/<%= thread.id %>" class="thread-title">
            <%= thread.title %>
          </a>
          <div class="thread-meta">
            <span>Szerz≈ë: <%= thread.author %></span>
            <span>| <%= new Date(thread.created_at).toLocaleDateString('hu-HU') %></span>
            <% if (thread.category_name) { %>
              <span class="thread-category"><%= thread.category_name %></span>
            <% } %>
          </div>
          <% if (thread.description) { %>
            <p style="margin-top: 5px; color: #666; font-size: 14px;">
              <%= thread.description.substring(0, 100) %>...
            </p>
          <% } %>
        </div>
        
        <!-- T√∂rl√©s gomb - admin vagy jogosult felhaszn√°l√≥knak -->
        <% if (isAdmin || canCreateMainThreads) { %>
          <div class="thread-actions">
            <button class="delete-thread-btn" onclick="deleteThread(<%= thread.id %>)" title="T√©ma t√∂rl√©se">
              üóëÔ∏è
            </button>
          </div>
        <% } %>
      </div>
    <% }); %>
  <% } else { %>
    <div class="no-threads">
      M√©g nincsenek t√©m√°k ebben a kateg√≥ri√°ban.
    </div>
  <% } %>
</div>

<!-- T√©ma l√©trehoz√°s modal - csak jogosult felhaszn√°l√≥knak -->
<% if (canCreateMainThreads) { %>
  <div id="createModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCreateModal()">&times;</span>
      <h2>√öj f≈ët√©ma l√©trehoz√°sa</h2>
      <form id="createMainThreadForm">
        <div class="form-group">
          <label for="title">T√©ma c√≠me:</label>
          <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
          <label for="description">Le√≠r√°s:</label>
          <textarea id="description" name="description" placeholder="R√∂vid le√≠r√°s a t√©m√°r√≥l..." required></textarea>
        </div>
        <div class="form-group">
          <label for="categoryId">Kateg√≥ria:</label>
          <select id="categoryId" name="categoryId" required>
            <option value="">V√°lassz kateg√≥ri√°t</option>
            <% categories.forEach(category => { %>
              <option value="<%= category.id %>"><%= category.name %></option>
            <% }); %>
          </select>
        </div>
        <button type="submit" class="submit-btn">F≈ët√©ma l√©trehoz√°sa</button>
      </form>
    </div>
  </div>
<% } %>

<script>
// Modal kezel√©s
function openCreateModal() {
  document.getElementById('createModal').style.display = 'block';
}

function closeCreateModal() {
  document.getElementById('createModal').style.display = 'none';
}

// Kateg√≥ria sz≈±r√©s
function filterByCategory(categoryId) {
  if (categoryId === '') {
    window.location.href = '/forum';
  } else {
    window.location.href = `/forum/category/${categoryId}`;
  }
}

// F≈ët√©ma l√©trehoz√°s
<% if (canCreateMainThreads) { %>
document.getElementById('createMainThreadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = {
    title: formData.get('title'),
    description: formData.get('description'),
    categoryId: formData.get('categoryId')
  };

  try {
    const response = await fetch('/create-main-thread', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.success) {
      alert('F≈ët√©ma sikeresen l√©trehozva!');
      window.location.reload();
    } else {
      alert('Hiba: ' + result.error);
    }
  } catch (error) {
    console.error('Hiba:', error);
    alert('Hiba t√∂rt√©nt a t√©ma l√©trehoz√°sakor.');
  }
});
<% } %>

// T√©ma t√∂rl√©s
<% if (isAdmin || canCreateMainThreads) { %>
async function deleteThread(threadId) {
  if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a t√©m√°t? Ez a m≈±velet nem visszavonhat√≥ √©s az √∂sszes alt√©m√°t is t√∂rli!')) {
    try {
      const response = await fetch(`/delete-thread/${threadId}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        alert('T√©ma sikeresen t√∂r√∂lve!');
        window.location.reload();
      } else {
        alert('Hiba: ' + result.error);
      }
    } catch (error) {
      console.error('Hiba:', error);
      alert('Hiba t√∂rt√©nt a t√©ma t√∂rl√©se sor√°n.');
    }
  }
}
<% } %>

// Modal bez√°r√°s kattint√°sra
window.onclick = function(event) {
  const modal = document.getElementById('createModal');
  if (event.target == modal) {
    closeCreateModal();
  }
}
</script>

<style>

.thread-actions {
  margin-left: 15px;
}

.delete-thread-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 3px;
  transition: background-color 0.3s;
}

.delete-thread-btn:hover {
  background-color: #ff4444;
  color: white;
}
</style>

<%- include("partials/footer.ejs") %>