<%- include("partials/header-logged.ejs") %>

<div class="container">
  <!-- Visszat√©r√©s a f√≥rumra -->
  <div class="breadcrumb">
    <a href="/forum">‚Üê Vissza a f√≥rumra</a>
    <% if (thread.category_name) { %>
      <span class="category-name" style="margin-left: 10px;">| <%= thread.category_name %></span>
    <% } %>
  </div>

  <!-- F≈ët√©ma inform√°ci√≥i -->
  <div class="main-thread">
    <div class="thread-header">
      <h1><%= thread.title %></h1>
      <div class="thread-meta">
        <span>Szerz≈ë: <%= thread.author %></span>
        <span>| <%= new Date(thread.created_at).toLocaleDateString('hu-HU') %></span>
        
        <!-- F≈ët√©ma t√∂rl√©s gomb -->
        <% if (isAdmin || canCreateMainThreads) { %>
          <button class="delete-thread-btn" onclick="deleteThread(<%= thread.id %>)" title="T√©ma t√∂rl√©se">
            üóëÔ∏è T√©ma t√∂rl√©se
          </button>
        <% } %>
      </div>
    </div>
    
    <% if (thread.description) { %>
      <div class="thread-description">
        <p><%= thread.description %></p>
      </div>
    <% } %>
  </div>

  <!-- Alt√©ma l√©trehoz√°s gomb -->
  <div class="create-subthread-section">
    <button class="create-subthread-btn" onclick="openCreateModal()">
      √öj alt√©ma l√©trehoz√°sa
    </button>
  </div>

  <!-- Alt√©m√°k list√°ja -->
  <div class="subthreads-section">
    <h2>Alt√©m√°k</h2>
    <div class="subthread-list">
      <% if (subthreads && subthreads.length > 0) { %>
        <% subthreads.forEach(subthread => { %>
          <div class="subthread-item">
            <div class="subthread-info">
              <a href="/thread/<%= subthread.id %>" class="subthread-title">
                <%= subthread.title %>
              </a>
              <div class="subthread-meta">
                <span>Szerz≈ë: <%= subthread.author %></span>
                <span>| <%= new Date(subthread.created_at).toLocaleDateString('hu-HU') %></span>
              </div>
              <% if (subthread.description) { %>
                <p class="subthread-description">
                  <%= subthread.description.substring(0, 150) %>...
                </p>
              <% } %>
            </div>
            
            <!-- Alt√©ma t√∂rl√©s gomb -->
            <% if (isAdmin || canCreateMainThreads) { %>
              <div class="subthread-actions">
                <button class="delete-thread-btn" onclick="deleteThread(<%= subthread.id %>)" title="Alt√©ma t√∂rl√©se">
                  üóëÔ∏è
                </button>
              </div>
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <div class="no-subthreads">
          M√©g nincsenek alt√©m√°k.
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Alt√©ma l√©trehoz√°s modal -->
<div id="createModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCreateModal()">&times;</span>
    <h2>√öj alt√©ma l√©trehoz√°sa</h2>
    <form method="POST" action="/create-thread">
      <input type="hidden" name="parentId" value="<%= thread.id %>">
      <input type="hidden" name="categoryId" value="<%= thread.category_id %>">
      
      <div class="form-group">
        <label for="title">Alt√©ma c√≠me:</label>
        <input type="text" id="title" name="title" required>
      </div>
      
      <div class="form-group">
        <label for="description">Le√≠r√°s:</label>
        <textarea id="description" name="description" placeholder="R√∂vid le√≠r√°s az alt√©m√°r√≥l..."></textarea>
      </div>
      
      <button type="submit" class="submit-btn">Alt√©ma l√©trehoz√°sa</button>
    </form>
  </div>
</div>

<script>
// Modal kezel√©s
function openCreateModal() {
  document.getElementById('createModal').style.display = 'block';
}

function closeCreateModal() {
  document.getElementById('createModal').style.display = 'none';
}

// T√©ma/alt√©ma t√∂rl√©s
<% if (isAdmin || canCreateMainThreads) { %>
async function deleteThread(threadId) {
  const isMainThread = threadId == <%= thread.id %>;
  const confirmMessage = isMainThread 
    ? 'Biztosan t√∂r√∂lni szeretn√©d ezt a f≈ët√©m√°t? Ez a m≈±velet nem visszavonhat√≥ √©s az √∂sszes alt√©m√°t is t√∂rli!'
    : 'Biztosan t√∂r√∂lni szeretn√©d ezt az alt√©m√°t? Ez a m≈±velet nem visszavonhat√≥!';
  
  if (confirm(confirmMessage)) {
    try {
      const response = await fetch(`/delete-thread/${threadId}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        alert('T√©ma sikeresen t√∂r√∂lve!');
        if (isMainThread) {
          // Ha a f≈ët√©m√°t t√∂r√∂lt√ºk, visszair√°ny√≠t√°s a f√≥rumra
          window.location.href = '/forum';
        } else {
          // Ha alt√©m√°t t√∂r√∂lt√ºk, oldal √∫jrat√∂lt√©se
          window.location.reload();
        }
      } else {
        alert('Hiba: ' + result.error);
      }
    } catch (error) {
      console.error('Hiba:', error);
      alert('Hiba t√∂rt√©nt a t√©ma t√∂rl√©se sor√°n.');
    }
  }
}
<% } %>

// Modal bez√°r√°s kattint√°sra
window.onclick = function(event) {
  const modal = document.getElementById('createModal');
  if (event.target == modal) {
    closeCreateModal();
  }
}
</script>

<style>

.subthread-actions {
  margin-left: 15px;
}

.delete-thread-btn {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 3px;
  transition: background-color 0.3s;
  color: #dc3545;
}

.delete-thread-btn:hover {
  background-color: #dc3545;
  color: white;
}


@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .thread-header {
    flex-direction: column;
    gap: 10px;
  }
  
  .subthread-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .subthread-actions {
    margin-left: 0;
    align-self: flex-end;
  }
}
</style>

<%- include("partials/footer.ejs") %>